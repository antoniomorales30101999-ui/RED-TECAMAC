<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RED TECAMAC</title>

    <script>
        var claveCorrecta = "Tecamac2026*";
        if (sessionStorage.getItem("acceso_permitido") !== "true") {
            var intento = prompt("üîê ACCESO\nIngrese clave:");
            if (intento === claveCorrecta) { sessionStorage.setItem("acceso_permitido", "true"); }
            else { window.location.href = "https://google.com"; }
        }
    </script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <style>
        body { background-color: #0d1b2a; color: #e0e1dd; font-family: 'Segoe UI', sans-serif; padding: 20px; }
        
        /* BUSCADOR 1: MANUAL */
        .search-manual { background: #1b263b; padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #415a77; }
        #manualSearch { background: #0d1b2a; border: 1px solid #00a8ff; color: white; border-radius: 5px; width: 100%; padding: 10px; }

        /* BUSCADOR 2: LOGS (EXTRACTOR) */
        .search-log { background: #1b263b; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 1px solid #415a77; }
        .label-log { font-size: 0.85rem; color: #8ecae6; text-align: center; margin-bottom: 10px; display: block; font-weight: bold; }
        #logInput { background: #0d1b2a; border: 1px solid #3fb950; color: #3fb950; border-radius: 5px; width: 100%; font-family: monospace; padding: 10px; font-size: 0.85rem; }

        /* TABLA */
        #contenedorTabla { display: none; margin-top: 25px; background: #1b263b; padding: 20px; border-radius: 10px; }
        .table { color: #fff !important; border: 1px solid #415a77 !important; }
        .table thead th { background: #0d1b2a !important; color: #00a8ff !important; border-bottom: 2px solid #415a77 !important; text-align: center; }
        .table td { text-align: center; border-color: #415a77 !important; }
        
        #noEncontrados { color: #e63946; text-align: center; margin-top: 15px; font-size: 0.85rem; display: none; }
    </style>
</head>
<body>

<div class="search-manual">
    <input type="text" id="manualSearch" placeholder="üîç buscar...">
</div>

<div class="buscar mdr...">
    <span class="label-log">Buscar Coincidencias En Cuentas (Pegar Log OLT):</span>
    <textarea id="logInput" rows="3" placeholder="Pegue aqu√≠ el texto con Activated (Online)..."></textarea>
</div>

<div id="contenedorTabla">
    <div class="text-center small mb-3">Tabla De Cuentas Buscadas:</div>
    <table id="tablaMaestra" class="table table-bordered w-100">
        <thead>
            <tr>
                <th>QR</th><th>OLT</th><th>Latitud</th><th>Longitud</th><th>S. Perdido</th><th>Cuenta</th>
            </tr>
        </thead>
    </table>
</div>

<div id="noEncontrados">Cuentas no encontradas: <span id="listaFaltantes"></span></div>

<script>
    var table;
    $(document).ready(function() {
        Papa.parse("datos.csv", {
            download: true,
            header: false,
            skipEmptyLines: true,
            complete: function(results) {
                table = $('#tablaMaestra').DataTable({
                    data: results.data,
                    deferRender: true,
                    dom: 't',
                    paging: false
                });

                // L√≥gica Buscador 1: Manual
                $('#manualSearch').on('input', function() {
                    var val = $(this).val();
                    if(val.length > 0) {
                        $('#contenedorTabla').show();
                        table.search(val).draw();
                    } else {
                        checkEmpty();
                    }
                });

                // L√≥gica Buscador 2: Log (Extractor de Cuentas 01XXXXXXXX)
                $('#logInput').on('input', function() {
                    var rawText = $(this).val();
                    var cuentas = rawText.match(/01\d{8}/g); // Busca cuentas que inician con 01

                    if (cuentas && cuentas.length > 0) {
                        var unicas = [...new Set(cuentas)];
                        $('#contenedorTabla').show();
                        // Filtra la columna 5 (Cuenta) con las cuentas encontradas
                        table.column(5).search(unicas.join('|'), true, false).draw();
                        actualizarFaltantes(unicas);
                    } else {
                        checkEmpty();
                    }
                });
            }
        });
    });

    function checkEmpty() {
        if($('#manualSearch').val() === "" && $('#logInput').val() === "") {
            $('#contenedorTabla, #noEncontrados').hide();
            table.search('').column(5).search('').draw();
        }
    }

    function actualizarFaltantes(buscadas) {
        var encontradas = table.rows({search:'applied'}).data().toArray().map(row => row[5]);
        var faltantes = buscadas.filter(c => !encontradas.includes(c));
        if (faltantes.length > 0) {
            $('#noEncontrados').show();
            $('#listaFaltantes').text(faltantes.join(', '));
        } else {
            $('#noEncontrados').hide();
        }
    }
</script>

</body>
</html>
