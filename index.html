<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RED TECAMAC - An√°lisis de Afectaciones</title>

    <script>
        var claveCorrecta = "Tecamac2026*";
        if (sessionStorage.getItem("acceso_permitido") !== "true") {
            var intento = prompt("üîê ACCESO\nIngrese clave:");
            if (intento === claveCorrecta) { sessionStorage.setItem("acceso_permitido", "true"); }
            else { window.location.href = "https://google.com"; }
        }
    </script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">

    <style>
        * { box-sizing: border-box; }
        body { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); min-height: 100vh; color: #e8e8e8; font-family: 'Segoe UI', sans-serif; padding: 0; margin: 0; }
        .app-header { background: linear-gradient(135deg, #00d4ff 0%, #0077b6 50%, #004a99 100%); color: white; padding: 30px 20px; text-align: center; box-shadow: 0 4px 30px rgba(0, 212, 255, 0.3); position: relative; overflow: hidden; }
        .app-header::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); }
        .app-header h1 { font-size: 2rem; font-weight: 700; text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3); position: relative; z-index: 1; }
        .app-header p { opacity: 0.9; font-size: 1rem; margin-top: 8px; position: relative; z-index: 1; }
        .main-container { max-width: 1400px; margin: 0 auto; padding: 30px 20px; }
        .nav-tabs-custom { display: flex; gap: 10px; margin-bottom: 25px; justify-content: center; }
        .tab-btn { background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(0, 212, 255, 0.3); color: #ccc; padding: 15px 35px; border-radius: 50px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s ease; backdrop-filter: blur(10px); }
        .tab-btn:hover { background: rgba(0, 212, 255, 0.2); border-color: #00d4ff; color: white; transform: translateY(-2px); }
        .tab-btn.active { background: linear-gradient(135deg, #00d4ff, #0077b6); border-color: #00d4ff; color: white; box-shadow: 0 5px 25px rgba(0, 212, 255, 0.4); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .search-wrapper { max-width: 700px; margin: 0 auto 30px auto; }
        #mainSearch { background: rgba(255, 255, 255, 0.95); border: none; border-radius: 50px !important; padding: 20px 30px !important; width: 100% !important; font-size: 1.1rem; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); outline: none; color: #333; transition: all 0.3s ease; }
        #mainSearch:focus { box-shadow: 0 10px 50px rgba(0, 212, 255, 0.5); transform: scale(1.02); }
        .analysis-panel { background: rgba(255, 255, 255, 0.05); border-radius: 20px; padding: 30px; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .paste-area { background: rgba(0, 0, 0, 0.3); border: 2px dashed rgba(0, 212, 255, 0.5); border-radius: 15px; padding: 20px; min-height: 200px; color: #ccc; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.85rem; resize: vertical; width: 100%; outline: none; transition: all 0.3s ease; }
        .btn-analyze { background: linear-gradient(135deg, #00d4ff, #0077b6); border: none; color: white; padding: 15px 50px; border-radius: 50px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-top: 20px; box-shadow: 0 5px 25px rgba(0, 212, 255, 0.4); }
        .btn-clear { background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.2); color: #ccc; padding: 15px 30px; border-radius: 50px; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; margin-top: 20px; margin-left: 10px; }
        .results-panel { margin-top: 30px; display: none; }
        .results-panel.visible { display: block; }
        .stats-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: rgba(255, 255, 255, 0.08); border-radius: 15px; padding: 20px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.1); }
        .stat-card .number { font-size: 2.5rem; font-weight: 700; background: linear-gradient(135deg, #00d4ff, #ff6b6b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        #contenedorTabla, #contenedorResultados { background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); color: #333; }
        .table { color: #333 !important; }
        .table thead th { background: linear-gradient(135deg, #004a99, #0077b6) !important; color: white !important; font-size: 0.75rem; padding: 15px 12px !important; }
        .qr-badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-weight: 600; font-size: 0.85rem; }
        .qr-hot { background: linear-gradient(135deg, #ff416c, #ff4b2b); color: white; animation: pulse 1.5s infinite; }
        .qr-warm { background: linear-gradient(135deg, #f7971e, #ffd200); color: #333; }
        .qr-normal { background: rgba(0, 119, 182, 0.15); color: #0077b6; }
        .not-found { background: rgba(255, 82, 82, 0.1) !important; color: #ff5252 !important; }
        .footer-info { text-align: center; padding: 20px; color: #666; font-size: 0.85rem; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 65, 108, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 65, 108, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 65, 108, 0); } }
    </style>
</head>

<body>

    <div class="app-header">
        <h1>üõ∞Ô∏è SISTEMA CORE TECAMAC</h1>
        <p>An√°lisis de Red y Afectaciones Masivas</p>
    </div>

    <div class="main-container">

        <div class="nav-tabs-custom">
            <button class="tab-btn active" data-tab="busqueda">üîç B√∫squeda Individual</button>
            <button class="tab-btn" data-tab="analisis">üìä An√°lisis Masivo</button>
        </div>

        <div id="tab-busqueda" class="tab-content active">
            <div class="search-wrapper">
                <input type="text" id="mainSearch" placeholder="üîç Buscar por Cuenta, QR u OLT..." autocomplete="off">
            </div>
            <div id="mensajeVacio" class="text-center mt-5">
                <p style="font-size: 3rem; margin-bottom: 10px;">üì°</p>
                <p>Ingresa un t√©rmino de b√∫squeda...</p>
            </div>
            <div id="contenedorTabla" style="display: none;">
                <table id="tablaMaestra" class="table table-hover w-100">
                    <thead>
                        <tr>
                            <th>Cuenta</th>
                            <th>QR</th>
                            <th>OLT</th>
                            <th>FSP</th>
                            <th>Lat</th>
                            <th>Lon</th>
                            <th>Ubicaci√≥n</th>
                            <th>Puerto N2</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>

        <div id="tab-analisis" class="tab-content">
            <div class="analysis-panel">
                <h4 style="color: #00d4ff; margin-bottom: 20px;">üìã Pegar datos del OLT</h4>
                <textarea id="pasteArea" class="paste-area" placeholder="Pega aqu√≠ los datos del OLT..."></textarea>
                <div class="text-center">
                    <button class="btn-analyze" onclick="analizarDatos()">üîé Analizar Afectaci√≥n</button>
                    <button class="btn-clear" onclick="limpiarAnalisis()">üóëÔ∏è Limpiar</button>
                </div>
            </div>

            <div id="resultadosAnalisis" class="results-panel">
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="number" id="statTotal">0</div>
                        <div class="label">Clientes Analizados</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="statEncontrados">0</div>
                        <div class="label">Encontrados</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="statNoEncontrados">0</div>
                        <div class="label">No Encontrados</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="statQRs">0</div>
                        <div class="label">QRs Afectados</div>
                    </div>
                </div>

                <div id="contenedorResultados">
                    <table id="tablaResultados" class="table table-hover w-100">
                        <thead>
                            <tr>
                                <th>Cuenta</th>
                                <th>QR</th>
                                <th>OLT</th>
                                <th>FSP</th>
                                <th>Lat</th> <th>Lon</th> <th>Ubicaci√≥n</th>
                                <th>Puerto N2</th>
                                <th>Clientes en QR</th>
                            </tr>
                        </thead>
                        <tbody id="bodyResultados"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <div class="footer-info">
        Sistema Core Tecamac | Datos cargados: <span id="totalRegistros">0</span> registros
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <script>
        var table;
        var datosCSV = [];
        var datosIndexados = {};

        $(document).ready(function () {
            $('.tab-btn').on('click', function () {
                var tabId = $(this).data('tab');
                $('.tab-btn').removeClass('active');
                $(this).addClass('active');
                $('.tab-content').removeClass('active');
                $('#tab-' + tabId).addClass('active');
            });

            Papa.parse("datos.csv", {
                download: true,
                header: false,
                skipEmptyLines: true,
                complete: function (results) {
                    datosCSV = results.data.slice(1);
                    $('#totalRegistros').text(datosCSV.length.toLocaleString());

                    // Indexaci√≥n mejorada para b√∫squeda instant√°nea
                    datosCSV.forEach(function (row) {
                        if (row[0]) {
                            var cuentaLimpia = row[0].replace(/\D/g, '').trim();
                            datosIndexados[cuentaLimpia] = row;
                        }
                    });

                    table = $('#tablaMaestra').DataTable({
                        data: datosCSV,
                        deferRender: true,
                        scrollY: "50vh",
                        scrollCollapse: true,
                        dom: 'rtip',
                        pageLength: 25,
                        language: { "info": "Mostrando _TOTAL_ registros", "paginate": { "next": "Sig", "previous": "Ant" } }
                    });

                    $('#mainSearch').on('keyup input', function () {
                        var val = $(this).val().trim();
                        if (val.length < 1) {
                            $('#contenedorTabla').hide();
                            $('#mensajeVacio').show();
                            table.search('').draw();
                        } else {
                            $('#contenedorTabla').show();
                            $('#mensajeVacio').hide();
                            table.search(val).draw();
                        }
                    });
                }
            });
        });

        function extraerCuentas(texto) {
            // Regex mejorado para capturar n√∫meros de 10 d√≠gitos o formato _TP_
            var regex = /(?:0\d{9})|(?:\d{10}(?=_TP_))/g;
            var matches = texto.match(regex) || [];
            return [...new Set(matches)];
        }

        function analizarDatos() {
            var texto = $('#pasteArea').val();
            if (!texto.trim()) return alert('Pega los datos primero.');

            var cuentas = extraerCuentas(texto);
            var resultados = [];
            var conteoQR = {};
            var encontrados = 0;
            var noEncontrados = 0;

            cuentas.forEach(function (cuenta) {
                var cuentaLimpia = cuenta.replace(/\D/g, '');
                var datos = datosIndexados[cuentaLimpia];
                
                if (datos) {
                    encontrados++;
                    var qr = datos[1] || 'N/A';
                    conteoQR[qr] = (conteoQR[qr] || 0) + 1;
                    resultados.push({
                        cuenta: cuenta,
                        qr: qr,
                        olt: datos[2] || '',
                        fsp: datos[3] || '',
                        lat: datos[4] || '',
                        lon: datos[5] || '',
                        ubicacion: datos[6] || '',
                        puerto: datos[7] || '',
                        encontrado: true
                    });
                } else {
                    noEncontrados++;
                    resultados.push({
                        cuenta: cuenta, qr: 'NO ENCONTRADO', olt: '', fsp: '', lat: '', lon: '', ubicacion: '', puerto: '', encontrado: false
                    });
                }
            });

            var html = '';
            resultados.forEach(function (r) {
                var rowClass = r.encontrado ? '' : 'not-found';
                var qrCount = conteoQR[r.qr] || 0;
                var badgeClass = qrCount >= 5 ? 'qr-hot' : (qrCount >= 3 ? 'qr-warm' : 'qr-normal');
                
                // Link din√°mico a Google Maps si existen coordenadas
                var contenidoUbicacion = (r.lat && r.lon) 
                    ? `<a href="https://www.google.com/maps?q=${r.lat},${r.lon}" target="_blank" style="text-decoration:none;">üìç ${r.ubicacion || 'Ver Mapa'}</a>` 
                    : (r.ubicacion || '-');

                html += '<tr class="' + rowClass + '">';
                html += '<td><strong>' + r.cuenta + '</strong></td>';
                html += '<td><span class="qr-badge ' + (r.encontrado ? badgeClass : '') + '">' + r.qr + '</span></td>';
                html += '<td>' + r.olt + '</td>';
                html += '<td>' + r.fsp + '</td>';
                html += '<td>' + r.lat + '</td>';
                html += '<td>' + r.lon + '</td>';
                html += '<td>' + contenidoUbicacion + '</td>';
                html += '<td>' + r.puerto + '</td>';
                html += '<td>' + (r.encontrado ? qrCount : '-') + '</td>';
                html += '</tr>';
            });

            $('#bodyResultados').html(html);
            $('#statTotal').text(cuentas.length);
            $('#statEncontrados').text(encontrados);
            $('#statNoEncontrados').text(noEncontrados);
            $('#statQRs').text(Object.keys(conteoQR).length);
            $('#resultadosAnalisis').addClass('visible');
        }

        function limpiarAnalisis() {
            $('#pasteArea').val('');
            $('#resultadosAnalisis').removeClass('visible');
            $('#bodyResultados').empty();
        }
    </script>

</body>
</html>
